# ml-spy-trading
SPY Market Direction Prediction with LightGBM
This repository presents a robust, multi-stage quantitative framework for forecasting the 30-day forward returns of the SPDR S&P 500 ETF Trust (SPY) using the LightGBM machine learning model. The project emphasizes rigorous out-of-sample validation techniques, including walk-forward backtesting and bootstrapping, to mitigate common pitfalls like data leakage and overfitting in financial time series analysis.

Project Overview
The core objective is to develop a systematic trading strategy that can potentially outperform a passive Buy-&-Hold benchmark. This is achieved through a comprehensive pipeline that covers:

Centralized Data Acquisition: Reproducible download and storage of SPY OHLCV data and macroeconomic indicators.

Systematic Feature Engineering: Creation of 17 diverse technical and macroeconomic signals.

Randomized Model and Feature-Subset Search: Efficient exploration of LightGBM hyperparameters and feature combinations.

Rigorous Multi-Period Walk-Forward Backtesting: Sequential evaluation of model performance on unseen data over multiple, non-overlapping periods.


Bootstrapping for Robustness Assessment: Statistical validation of model stability across various out-of-sample scenarios.

Single-Model Walk-Forward Simulation: A final, comprehensive backtest of the best-performing model against a Buy-&-Hold benchmark.

Methodology Highlights
Data Sources: SPY (OHLCV) , Ten-year yield (\textsuperscript{\textasciicircum}TNX), five-year yield (\textsuperscript{\textasciicircum}FVX) , Bond-option volatility (MOVE) , High-yield ETF (HYG) , Treasury ETF (IEF) , Equal-weight S&P 500 (RSP) , Equity-option volatility (VIX) , Three-month yield (IRX). Data spans from 2000-01-01 to 2025-07-01.


Features: 17 signals including Moving Averages (M30_MA, M10_MA) , Momentum (MACD_DIFF, Price_Momentum_5D) , Volume (OBV, Volume_Spike) , Breadth (Market_Breadth) , Volatility (Williams %R, RSI_7, RSI_14, ADX_14, StochRSI_14, VIX_Change_5D) , Downside (Down_Moves, MACD_Bearish_Cross) , and Yields (HYG_IEF, Yield_Slope).





Target: Binary classification: Target_t = 1 if Close_{t+30} > Close_t, else 0. The target is computed globally on the full dataset; the final 30 rows are dropped, leaving 4,499 observations.


Model: LightGBM Classifier.

Validation:

Random Search: 5,000 trials for hyperparameter and feature-subset optimization.

Walk-Forward Backtesting: Four consecutive one-year test folds with re-training and re-feature computation in each period.

Bootstrapping: 50 random out-of-sample periods for robustness assessment.

Performance (2023-01-01 to 2025-06-30)
The "Optimized Strategy (Fixed)" demonstrated significant outperformance against a Buy-&-Hold SPY benchmark:

Metric

Optimized Strategy (Fixed)

Buy & Hold (SPY)

Total Return

71.78 %

67.82 %

Annualized Return

24.60 %

23.42 %

Annualized Volatility

11.36 %

16.16 %

Sharpe Ratio

2.17

1.45

(Note: The figure illustrating cumulative returns will be generated when you run the optimal_vs_spy.py script.) 

Repository Structure
spy_ohlcv_macro_data_2000_2025.csv: The primary dataset containing SPY OHLCV and macroeconomic indicators. If not present, it will be downloaded by the scripts.

final.py: This script executes the full multi-stage framework:

Performs the randomized model and feature-subset search.

Conducts the multi-period walk-forward backtesting.

Runs the bootstrapping for robustness assessment.

Outputs intermediate and final model performance results to Excel files.

optimal_vs_spy.py: This script performs the final single-model walk-forward simulation using the "Optimized Strategy (Fixed)" parameters and generates the cumulative returns plot comparing it against Buy-&-Hold.

model_results_seed42.xlsx: (Generated by final.py) Stores the results from the randomized search phase.

walk_forward_backtest_results.xlsx: (Generated by final.py) Stores the aggregated results from the multi-period walk-forward backtesting.

final_combined_backtest_results.xlsx: (Generated by final.py) Contains the comprehensive results, including bootstrapping metrics, for all models that passed the walk-forward filters.

How to Run
Clone the repository:

Bash
git clone <your-repo-url>
cd <your-repo-name>
Install Dependencies: Ensure you have Python 3 installed. Then, install the required libraries:

Bash
pip install yfinance pandas numpy pandas_ta lightgbm tqdm scikit-learn matplotlib openpyxl
(openpyxl is needed for reading/writing Excel files.)

Execute the Full Framework (final.py):
This script will download the necessary data (if not already present), perform the extensive model search, walk-forward backtesting, and bootstrapping. It will generate the model_results_seed42.xlsx, walk_forward_backtest_results.xlsx, and final_combined_backtest_results.xlsx files.

Bash
python final.py
Run the Final Strategy Comparison (optimal_vs_spy.py):
This script will load the data, apply the pre-defined "Optimized Strategy (Fixed)" parameters, run its walk-forward simulation, calculate final performance metrics, and display a cumulative returns plot.

Bash
python optimal_vs_spy.py
Future Work & Considerations
Transaction Costs and Slippage: The current framework does not account for real-world trading costs. Future work should integrate realistic transaction cost and slippage models.

Dynamic Risk Constraints: Incorporating dynamic risk management rules (e.g., position sizing, stop-losses) could further enhance practical deployment.

Alternative Feature Universes: Exploration of additional feature categories (e.g., sentiment analysis, alternative data) could potentially improve predictive power.

Model Turnover: Analyzing and optimizing for model turnover (how often the model changes its predictions) is important for practical trading.

Acknowledgments
We extend our gratitude to the open-source maintainers of 

yfinance, pandas_ta, lightgbm, and related tools for enabling reproducible quantitative research.
